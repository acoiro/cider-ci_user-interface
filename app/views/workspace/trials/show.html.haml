-#  Copyright (C) 2013, 2014 Dr. Thomas Schank  (DrTom@schank.ch, Thomas.Schank@algocon.ch)
-#  Licensed under the terms of the GNU Affero General Public License v3.
-#  See the LICENSE.txt file provided with this software.

- trial ||= @trial 
- cache [trial.cache_signature,trial.trial_attachments.collection_cache_tag,admin?] do

  .row
    .col-md-6
      %ol.breadcrumb.pull-left
        =render '/breadcrumbs/trial', trial: trial
    .col-md-6
      %ol.breadcrumb.with-circle-separator.pull-right
        %li
          %ul.list-inline.list-unstyled
            %li 
              - if trial.trial_attachments.count > 0
                = link_to attachments_workspace_trial_path(trial) do
                  Attachments
              - else 
                %span.text-muted Attachments



  %ul.list-inline.actions.pull-right{style: "margin-top: 10px"}
    - if admin?
      %li 
        = form_tag workspace_trial_path(trial), method: 'DELETE' do
          = hidden_field_tag :authenticity_token, form_authenticity_token
          = button_tag type: :submit, class: "btn btn-danger" do
            %i.icon-trash
            Delete
      %li 
        = form_tag set_failed_workspace_trial_path(trial), method: 'POST' do
          = hidden_field_tag :authenticity_token, form_authenticity_token
          = button_tag type: :submit, class: "btn btn-danger" do
            %i.icon-failed
            Mark as failed

  %h1{style: "margin-top: 10px"}
    %span{class: "label #{label_class_for_state(trial.state)}"}<>
      %i{class: icon_class_for_state(trial.state)}<>
    %span{style: "margin-left: .5em"} Trial for the task "#{trial.task.name}"


  %p

    Executed 

    -if trial.started_at
      %b #{render 'humanized_time_from_now', at: trial.started_at}
    - if trial.finished_at and trial.started_at
      in 
      %b #{distance_of_time_in_words(trial.started_at,trial.finished_at,include_seconds: true)} 
      (#{(trial.finished_at - trial.started_at).round(2)} seconds)
    - if executor_name = trial.executor.try(:name)
      on 
      %b #{executor_name}.

  -unless trial.error.blank?
    %h3 Execution Error
    %pre
      %code= trial.error


  .scripts
    - if trial.scripts.blank?

      .panel.panel-warning
        .panel-heading
          %h2 Scripts missing
        .panel-body
          %p This trial does not have any scripts associated with it.

          %p 
            They might have been erased afer some period of time in order to save space. 
            Administrators can adjust the retention time.

    - else
      %h2 Scripts 
      %ul.list-inline 
        = render partial: 'script_label', collection: trial.scripts.map{|k,v| v.merge({"id" => k})}, as: :script

      %ul.list-unstyled.scripts
        = render partial: 'script', collection: trial.scripts.map{|k,v| v}
